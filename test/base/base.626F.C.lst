001   0000             ; ZX Spectrum test (c) 30-10-2019 Alemorf aleksey.f.morozov@gmail.com
002   0000             
003   0000             ; 4000 - screen
004   0000             ; 5B00 - cache
005   0000             ; 5E00 - free
006   0000             
007   0000                     DEVICE ZXSPECTRUM128
008   0000             
009   0000             moduleLoadAddr = 7000h
010   0000             stackAddr = 0C000h
011   0000             
012   0000             ;-------------------------------------------------------------------------------
013   0000             ; Точки входа
014   0000             
015   0000                 org 626Fh
016   626F             
017   626F C3 92 62    p_init:  JP   init
018   6272 00          frame db 0
019   6273 00          videoPage db 0
020   6274 00          systemPage db 0
021   6275 00          keyTrigger db 0
022   6276 00          keyPressed db 0
023   6277 C3 D4 69    p_drawText:  jp drawText
024   627A C3 ED 6A    p_drawTextCenter:  jp drawTextCenter
025   627D C3 E0 69    p_drawTextEx:  jp drawTextEx
026   6280 C3 2A 69    p_clearScreen:  jp clearScreen
027   6283 C3 6D 69    p_drawImage:  jp drawImage
028   6286 C3 D8 6A    p_measureText:  jp measureText
029   6289 C3 B3 69    p_calcCoords:  jp calcCoords
030   628C C3 E6 69    p_drawCharSub:  jp drawCharSub
031   628F C3 C9 62    p_exec:  jp exec
032   6292             
033   6292             ;-------------------------------------------------------------------------------
034   6292             
035   6292             init: 
036   6292                     ; Инициализация стека
037   6292 31 00 C0            LD    SP, stackAddr
038   6295             
039   6295                     ; Выбор второй видеостраницы
040   6295 AF                  XOR   A
041   6296 32 73 62            LD    (videoPage), A
042   6299 3E 17               LD    A, 17h
043   629B 32 74 62            LD    (systemPage), A
044   629E 01 FD 7F            LD    BC, 7FFDh
045   62A1 ED 79               OUT   (C), A
046   62A3             
047   62A3                     ; Установка обработчика прерываний (FE00-FFFFh)
048   62A3 3E 18               LD    A, 24       ;код команды JR
049   62A5 32 FF FF            LD    (65535), A
050   62A8 3E C3               LD    A, 195      ;код команды JP
051   62AA 32 F4 FF            LD    (65524), A
052   62AD 21 5B 63            LD    HL, IrqHandler
053   62B0 22 F5 FF            LD    (65525), HL ;в HL - адрес обработчика прерываний
054   62B3 21 00 FE            LD    HL, #FE00   ;построение таблицы для векторов прерываний
055   62B6 11 01 FE            LD    DE, #FE01
056   62B9 01 00 01            LD    BC, 256     ;размер таблицы минус 1
057   62BC 36 FF               LD    (HL), #FF   ;адрес перехода #FFFF (65535)
058   62BE 7C                  LD    A,H         ;запоминаем старший байт адреса таблицы
059   62BF ED B0               LDIR              ;заполняем таблицу
060   62C1 ED 47               LD    I,A         ;задаем в регистре I старший байт адреса
061   62C3                                       ; таблицы для векторов прерываний
062   62C3 ED 5E               IM    2           ;назначаем второй режим прерываний
063   62C5 FB                  EI                ;разрешаем прерывания
064   62C6             
065   62C6                     ; Загрузка файла
066   62C6 21 F3 62            LD    HL, aStart
067   62C9             
068   62C9             ;-------------------------------------------------------------------------------
069   62C9             
070   62C9             exec: 
071   62C9 31 00 C0            LD    SP, stackAddr
072   62CC             
073   62CC E5                  PUSH  HL
074   62CD                     ; Установка черной рамки
075   62CD 3E 00               LD    A, 0
076   62CF D3 FE               OUT   (-2), A
077   62D1                     ; Очистка всех экранов
078   62D1 3E 42               LD    A, 42h
079   62D3 CD 2A 69            CALL  clearScreen
080   62D6 E1                  POP   HL
081   62D7             
082   62D7 11 00 70            LD    DE, moduleLoadAddr
083   62DA CD 0A 63            CALL  loadFile
084   62DD C3 00 70            JP    moduleLoadAddr
085   62E0             
086   62E0             ;-------------------------------------------------------------------------------
087   62E0             
088   62E0             fileNotFound: 
089   62E0 21 00 00            ld   hl, 0
090   62E3 11 F8 62            ld   de, aFileNotFound
091   62E6 CD E0 69            call drawTextEx
092   62E9 21 00 0A            ld   hl, 10 << 8
093   62EC D1                  pop  de
094   62ED CD E0 69            call drawTextEx
095   62F0             
096   62F0 C3 F0 62            jp $
097   62F3             
098   62F3             ;-------------------------------------------------------------------------------
099   62F3             
100   62F3             ;aStart db "menu", 0
101   62F3 6369747900  aStart db "city", 0
102   62F8             aFileNotFound db "Не найден файл ", 0
102   62F8 CDE520EDE0E9E4E5ED20F4E0E9EB2000
103   6308             aSpace = $ - 2
104   6308 43 00       aExt db "C",0
105   630A             
106   630A             ;-------------------------------------------------------------------------------
107   630A             
108   630A             loadFile: 
109   630A                     ; Сохраняем адрес загрузки
110   630A D5                  push de
111   630B             
112   630B                     ; Преобразование имени файла
113   630B 01 08 08            ld   bc, 808h
114   630E             loadFile_0: 
115   630E 7E                  ld   a, (hl)
116   630F B7                  or   a
117   6310 C2 16 63            jp   nz, loadFile_1
118   6313 21 06 63            ld   hl, aSpace
119   6316             loadFile_1: 
120   6316 ED A0               ldi
121   6318 10 F4               djnz loadFile_0
122   631A 21 08 63            ld   hl, aExt
123   631D ED A0               ldi
124   631F ED A0               ldi
125   6321 E1                  pop  hl
126   6322             
127   6322                     ; Установка прерываний по умолчанию
128   6322 F3                  di
129   6323 ED 57               ld   a, i
130   6325 F5                  push af
131   6326 ED 56               im   1
132   6328             
133   6328                     ; Передача имени файла
134   6328 E5                  push hl
135   6329 0E 13               ld   c, 13h
136   632B CD 13 3D            call 3D13h
137   632E             
138   632E                     ; Поиск файла
139   632E 0E 0A               ld   c, 0Ah
140   6330 CD 13 3D            call 3D13h
141   6333 79                  ld   a, c
142   6334 FE FF               cp   0FFh
143   6336 CA E0 62            jp   z, fileNotFound ; Файл не найден
144   6339             
145   6339                     ; Загрузка заголовка
146   6339 0E 08               ld   c, 8
147   633B CD 13 3D            call 3D13h
148   633E             
149   633E                     ; Надо перенести имя
150   633E             
151   633E                     ; Загрузка файла
152   633E ED 5B EB 5C         ld   de, (5CEBh)
153   6342 3A EA 5C            ld   a, (5CEAh)
154   6345 47                  ld   b, a
155   6346 E1                  pop  hl
156   6347 0E 05               ld   c, 5
157   6349 CD 13 3D            call 3D13h
158   634C             
159   634C                     ; Восстановление страницы
160   634C 3A 74 62            LD    A, (systemPage)
161   634F 01 FD 7F            LD    BC, 7FFDh
162   6352 ED 79               OUT   (C), A
163   6354             
164   6354                     ; Восстановление прерываний
165   6354 F1                  pop  af
166   6355 ED 47               LD   i, a
167   6357 ED 5E               im   2
168   6359 FB                  ei
169   635A             
170   635A C9                  ret
171   635B             
172   635B             ;-------------------------------------------------------------------------------
173   635B             
174   635B             IrqHandler: 
175   635B F5                  PUSH  AF
176   635C C5                  PUSH  BC
177   635D E5                  PUSH  HL
178   635E             
179   635E                     ; Переключение видеостраницы
180   635E 3A 73 62            LD    A, (videoPage)
181   6361 CB 47               BIT   0, A
182   6363 CA 7A 63            JP    Z, irqHandler_1
183   6366 E6 08               AND   8
184   6368 32 73 62            LD    (videoPage), A
185   636B 47                  LD    B, A
186   636C 3A 74 62            LD    A, (systemPage)
187   636F E6 F7               AND   ~8
188   6371 B0                  OR    B
189   6372 32 74 62            LD    (systemPage), A
190   6375 01 FD 7F            LD    BC, 7FFDh
191   6378 ED 79               OUT   (C), A
192   637A             irqHandler_1: 
193   637A             
194   637A 3A 72 62            LD    A, (frame)
195   637D 3C                  INC   A
196   637E 32 72 62            LD    (frame), A
197   6381             
198   6381 CD FD 6A            call  readKey
199   6384             
200   6384 E1                  POP   HL
201   6385 C1                  POP   BC
202   6386 F1                  POP   AF
203   6387 FB                  EI
204   6388 ED 4D               RETI
205   638A             
001   638A             image_font: 
002   638A                 db 000h, 000h, 000h, 000h, 000h, 000h, 000h, 000h, 4 ; 0
002   638A 000000000000000004
003   6393                 db 020h, 020h, 020h, 020h, 020h, 000h, 020h, 000h, 6 ; 1
003   6393 202020202000200006
004   639C                 db 050h, 050h, 050h, 000h, 000h, 000h, 000h, 000h, 6 ; 2
004   639C 505050000000000006
005   63A5                 db 050h, 050h, 0F8h, 050h, 0F8h, 050h, 050h, 000h, 6 ; 3
005   63A5 5050F850F850500006
006   63AE                 db 088h, 070h, 088h, 088h, 088h, 070h, 088h, 000h, 6 ; 4
006   63AE 887088888870880006
007   63B7                 db 0C0h, 0C8h, 010h, 020h, 040h, 098h, 018h, 000h, 6 ; 5
007   63B7 C0C810204098180006
008   63C0                 db 040h, 0A0h, 0A0h, 040h, 0A8h, 090h, 068h, 000h, 6 ; 6
008   63C0 40A0A040A890680006
009   63C9                 db 020h, 020h, 020h, 000h, 000h, 000h, 000h, 000h, 6 ; 7
009   63C9 202020000000000006
010   63D2                 db 020h, 040h, 080h, 080h, 080h, 040h, 020h, 000h, 4 ; 8
010   63D2 204080808040200004
011   63DB                 db 080h, 040h, 020h, 020h, 020h, 040h, 080h, 000h, 4 ; 9
011   63DB 804020202040800004
012   63E4                 db 000h, 000h, 000h, 050h, 020h, 050h, 000h, 000h, 6 ; 10
012   63E4 000000502050000006
013   63ED                 db 000h, 020h, 020h, 0F8h, 020h, 020h, 000h, 000h, 6 ; 11
013   63ED 002020F82020000006
014   63F6                 db 000h, 000h, 000h, 000h, 000h, 000h, 040h, 080h, 3 ; 12
014   63F6 000000000000408003
015   63FF                 db 000h, 000h, 000h, 0F0h, 000h, 000h, 000h, 000h, 5 ; 13
015   63FF 000000F00000000005
016   6408                 db 000h, 000h, 000h, 000h, 000h, 000h, 040h, 000h, 4 ; 14
016   6408 000000000000400004
017   6411                 db 000h, 008h, 010h, 020h, 040h, 080h, 000h, 000h, 6 ; 15
017   6411 000810204080000006
018   641A                 db 060h, 090h, 090h, 090h, 090h, 090h, 060h, 000h, 5 ; 16
018   641A 609090909090600005
019   6423                 db 040h, 0C0h, 040h, 040h, 040h, 040h, 0E0h, 000h, 4 ; 17
019   6423 40C040404040E00004
020   642C                 db 060h, 090h, 010h, 020h, 040h, 080h, 0F0h, 000h, 5 ; 18
020   642C 609010204080F00005
021   6435                 db 060h, 090h, 010h, 020h, 010h, 090h, 060h, 000h, 5 ; 19
021   6435 609010201090600005
022   643E                 db 010h, 030h, 050h, 090h, 0F0h, 010h, 010h, 000h, 5 ; 20
022   643E 10305090F010100005
023   6447                 db 0F0h, 080h, 0E0h, 010h, 010h, 010h, 0E0h, 000h, 5 ; 21
023   6447 F080E0101010E00005
024   6450                 db 060h, 080h, 0E0h, 090h, 090h, 090h, 060h, 000h, 5 ; 22
024   6450 6080E0909090600005
025   6459                 db 0F0h, 010h, 020h, 020h, 040h, 040h, 040h, 000h, 5 ; 23
025   6459 F01020204040400005
026   6462                 db 060h, 090h, 090h, 060h, 090h, 090h, 060h, 000h, 5 ; 24
026   6462 609090609090600005
027   646B                 db 060h, 090h, 090h, 070h, 010h, 010h, 060h, 000h, 5 ; 25
027   646B 609090701010600005
028   6474                 db 000h, 000h, 040h, 000h, 000h, 040h, 000h, 000h, 4 ; 26
028   6474 000040000040000004
029   647D                 db 000h, 000h, 040h, 000h, 000h, 040h, 040h, 000h, 4 ; 27
029   647D 000040000040400004
030   6486                 db 010h, 020h, 040h, 080h, 040h, 020h, 010h, 000h, 5 ; 28
030   6486 102040804020100005
031   648F                 db 000h, 000h, 0F8h, 000h, 0F8h, 000h, 000h, 000h, 6 ; 29
031   648F 0000F800F800000006
032   6498                 db 040h, 020h, 010h, 008h, 010h, 020h, 040h, 000h, 7 ; 30
032   6498 402010081020400007
033   64A1                 db 060h, 090h, 010h, 020h, 020h, 000h, 020h, 000h, 5 ; 31
033   64A1 609010202000200005
034   64AA                 db 000h, 040h, 060h, 070h, 060h, 040h, 000h, 000h, 6 ; 32
034   64AA 004060706040000006
035   64B3                 db 020h, 050h, 088h, 088h, 0F8h, 088h, 088h, 000h, 6 ; 33
035   64B3 20508888F888880006
036   64BC                 db 0F0h, 088h, 088h, 0F0h, 088h, 088h, 0F0h, 000h, 6 ; 34
036   64BC F08888F08888F00006
037   64C5                 db 070h, 088h, 080h, 080h, 080h, 088h, 070h, 000h, 6 ; 35
037   64C5 708880808088700006
038   64CE                 db 0F0h, 088h, 088h, 088h, 088h, 088h, 0F0h, 000h, 6 ; 36
038   64CE F08888888888F00006
039   64D7                 db 0F8h, 080h, 080h, 0F0h, 080h, 080h, 0F8h, 000h, 6 ; 37
039   64D7 F88080F08080F80006
040   64E0                 db 0F8h, 080h, 080h, 0F0h, 080h, 080h, 080h, 000h, 6 ; 38
040   64E0 F88080F08080800006
041   64E9                 db 078h, 080h, 080h, 080h, 098h, 088h, 078h, 000h, 6 ; 39
041   64E9 788080809888780006
042   64F2                 db 088h, 088h, 088h, 0F8h, 088h, 088h, 088h, 000h, 6 ; 40
042   64F2 888888F88888880006
043   64FB                 db 070h, 020h, 020h, 020h, 020h, 020h, 070h, 000h, 6 ; 41
043   64FB 702020202020700006
044   6504                 db 008h, 008h, 008h, 008h, 008h, 088h, 070h, 000h, 6 ; 42
044   6504 080808080888700006
045   650D                 db 088h, 090h, 0A0h, 0C0h, 0A0h, 090h, 088h, 000h, 6 ; 43
045   650D 8890A0C0A090880006
046   6516                 db 080h, 080h, 080h, 080h, 080h, 080h, 0F8h, 000h, 6 ; 44
046   6516 808080808080F80006
047   651F                 db 088h, 0D8h, 0A8h, 0A8h, 088h, 088h, 088h, 000h, 6 ; 45
047   651F 88D8A8A88888880006
048   6528                 db 088h, 088h, 0C8h, 0A8h, 098h, 088h, 088h, 000h, 6 ; 46
048   6528 8888C8A89888880006
049   6531                 db 070h, 088h, 088h, 088h, 088h, 088h, 070h, 000h, 6 ; 47
049   6531 708888888888700006
050   653A                 db 0F0h, 088h, 088h, 0F0h, 080h, 080h, 080h, 000h, 6 ; 48
050   653A F08888F08080800006
051   6543                 db 070h, 088h, 088h, 088h, 0A8h, 090h, 068h, 000h, 6 ; 49
051   6543 70888888A890680006
052   654C                 db 0F0h, 088h, 088h, 0F0h, 0A0h, 090h, 088h, 000h, 6 ; 50
052   654C F08888F0A090880006
053   6555                 db 070h, 088h, 080h, 070h, 008h, 088h, 070h, 000h, 6 ; 51
053   6555 708880700888700006
054   655E                 db 0F8h, 020h, 020h, 020h, 020h, 020h, 020h, 000h, 6 ; 52
054   655E F82020202020200006
055   6567                 db 088h, 088h, 088h, 088h, 088h, 088h, 070h, 000h, 6 ; 53
055   6567 888888888888700006
056   6570                 db 088h, 088h, 088h, 088h, 088h, 050h, 020h, 000h, 6 ; 54
056   6570 888888888850200006
057   6579                 db 088h, 088h, 088h, 0A8h, 0A8h, 0D8h, 088h, 000h, 6 ; 55
057   6579 888888A8A8D8880006
058   6582                 db 088h, 088h, 050h, 020h, 050h, 088h, 088h, 000h, 6 ; 56
058   6582 888850205088880006
059   658B                 db 088h, 088h, 050h, 020h, 020h, 020h, 020h, 000h, 6 ; 57
059   658B 888850202020200006
060   6594                 db 0F8h, 008h, 010h, 020h, 040h, 080h, 0F8h, 000h, 6 ; 58
060   6594 F80810204080F80006
061   659D                 db 078h, 040h, 040h, 040h, 040h, 040h, 078h, 000h, 7 ; 59
061   659D 784040404040780007
062   65A6                 db 000h, 080h, 040h, 020h, 010h, 008h, 000h, 000h, 6 ; 60
062   65A6 008040201008000006
063   65AF                 db 0F0h, 010h, 010h, 010h, 010h, 010h, 0F0h, 000h, 5 ; 61
063   65AF F01010101010F00005
064   65B8                 db 000h, 020h, 050h, 088h, 000h, 000h, 000h, 000h, 6 ; 62
064   65B8 002050880000000006
065   65C1                 db 000h, 000h, 000h, 000h, 000h, 000h, 000h, 0FCh, 7 ; 63
065   65C1 00000000000000FC07
066   65CA                 db 040h, 020h, 010h, 000h, 000h, 000h, 000h, 000h, 6 ; 64
066   65CA 402010000000000006
067   65D3                 db 000h, 000h, 060h, 010h, 070h, 090h, 070h, 000h, 5 ; 65
067   65D3 000060107090700005
068   65DC                 db 080h, 080h, 0E0h, 090h, 090h, 090h, 0E0h, 000h, 5 ; 66
068   65DC 8080E0909090E00005
069   65E5                 db 000h, 000h, 070h, 080h, 080h, 080h, 070h, 000h, 5 ; 67
069   65E5 000070808080700005
070   65EE                 db 010h, 010h, 070h, 090h, 090h, 090h, 070h, 000h, 5 ; 68
070   65EE 101070909090700005
071   65F7                 db 000h, 000h, 060h, 090h, 0F0h, 080h, 060h, 000h, 5 ; 69
071   65F7 00006090F080600005
072   6600                 db 030h, 048h, 040h, 0F0h, 040h, 040h, 040h, 000h, 6 ; 70
072   6600 304840F04040400006
073   6609                 db 000h, 000h, 070h, 090h, 090h, 070h, 010h, 060h, 5 ; 71
073   6609 000070909070106005
074   6612                 db 080h, 080h, 0E0h, 090h, 090h, 090h, 090h, 000h, 5 ; 72
074   6612 8080E0909090900005
075   661B                 db 080h, 000h, 080h, 080h, 080h, 080h, 080h, 000h, 2 ; 73
075   661B 800080808080800002
076   6624                 db 010h, 000h, 030h, 010h, 010h, 010h, 090h, 060h, 5 ; 74
076   6624 100030101010906005
077   662D                 db 080h, 080h, 090h, 0A0h, 0C0h, 0A0h, 090h, 000h, 5 ; 75
077   662D 808090A0C0A0900005
078   6636                 db 080h, 080h, 080h, 080h, 080h, 080h, 080h, 000h, 2 ; 76
078   6636 808080808080800002
079   663F                 db 000h, 000h, 0D8h, 0A8h, 0A8h, 0A8h, 0A8h, 000h, 6 ; 77
079   663F 0000D8A8A8A8A80006
080   6648                 db 000h, 000h, 0A0h, 0D0h, 090h, 090h, 090h, 000h, 5 ; 78
080   6648 0000A0D09090900005
081   6651                 db 000h, 000h, 060h, 090h, 090h, 090h, 060h, 000h, 5 ; 79
081   6651 000060909090600005
082   665A                 db 000h, 000h, 0E0h, 090h, 090h, 0E0h, 080h, 080h, 5 ; 80
082   665A 0000E09090E0808005
083   6663                 db 000h, 000h, 070h, 090h, 090h, 070h, 010h, 010h, 5 ; 81
083   6663 000070909070101005
084   666C                 db 000h, 000h, 0B0h, 0C0h, 080h, 080h, 080h, 000h, 5 ; 82
084   666C 0000B0C08080800005
085   6675                 db 000h, 000h, 060h, 080h, 060h, 010h, 060h, 000h, 5 ; 83
085   6675 000060806010600005
086   667E                 db 040h, 040h, 0E0h, 040h, 040h, 040h, 030h, 000h, 5 ; 84
086   667E 4040E0404040300005
087   6687                 db 000h, 000h, 090h, 090h, 090h, 0B0h, 050h, 000h, 5 ; 85
087   6687 0000909090B0500005
088   6690                 db 000h, 000h, 088h, 088h, 050h, 050h, 020h, 000h, 6 ; 86
088   6690 000088885050200006
089   6699                 db 000h, 000h, 088h, 088h, 0A8h, 0A8h, 050h, 000h, 6 ; 87
089   6699 00008888A8A8500006
090   66A2                 db 000h, 000h, 088h, 050h, 020h, 050h, 088h, 000h, 6 ; 88
090   66A2 000088502050880006
091   66AB                 db 000h, 000h, 090h, 090h, 090h, 070h, 010h, 060h, 5 ; 89
091   66AB 000090909070106005
092   66B4                 db 000h, 000h, 0F0h, 020h, 040h, 080h, 0F0h, 000h, 5 ; 90
092   66B4 0000F0204080F00005
093   66BD                 db 000h, 000h, 048h, 090h, 048h, 000h, 000h, 000h, 6 ; 91
093   66BD 000048904800000006
094   66C6                 db 078h, 084h, 0B4h, 0A4h, 0B4h, 084h, 078h, 000h, 7 ; 92
094   66C6 7884B4A4B484780007
095   66CF                 db 000h, 000h, 090h, 048h, 090h, 000h, 000h, 000h, 6 ; 93
095   66CF 000090489000000006
096   66D8                 db 0FCh, 000h, 000h, 000h, 000h, 000h, 000h, 000h, 7 ; 94
096   66D8 FC0000000000000007
097   66E1                 db 050h, 000h, 070h, 088h, 0F8h, 080h, 078h, 000h, 6 ; 95
097   66E1 50007088F880780006
098   66EA                 db 070h, 088h, 088h, 088h, 0F8h, 088h, 088h, 000h, 6 ; 96
098   66EA 70888888F888880006
099   66F3                 db 0F8h, 080h, 080h, 0F0h, 088h, 088h, 0F0h, 000h, 6 ; 97
099   66F3 F88080F08888F00006
100   66FC                 db 0F0h, 088h, 088h, 0F0h, 088h, 088h, 0F0h, 000h, 6 ; 98
100   66FC F08888F08888F00006
101   6705                 db 0F8h, 080h, 080h, 080h, 080h, 080h, 080h, 000h, 6 ; 99
101   6705 F88080808080800006
102   670E                 db 038h, 048h, 048h, 048h, 048h, 048h, 0FCh, 084h, 7 ; 100
102   670E 384848484848FC8407
103   6717                 db 0F8h, 080h, 080h, 0F0h, 080h, 080h, 0F8h, 000h, 6 ; 101
103   6717 F88080F08080F80006
104   6720                 db 0A8h, 0A8h, 0A8h, 070h, 0A8h, 0A8h, 0A8h, 000h, 6 ; 102
104   6720 A8A8A870A8A8A80006
105   6729                 db 070h, 088h, 008h, 030h, 008h, 088h, 070h, 000h, 6 ; 103
105   6729 708808300888700006
106   6732                 db 088h, 088h, 098h, 0A8h, 0C8h, 088h, 088h, 000h, 6 ; 104
106   6732 888898A8C888880006
107   673B                 db 088h, 088h, 098h, 0A8h, 0C8h, 088h, 088h, 000h, 6 ; 105
107   673B 888898A8C888880006
108   6744                 db 088h, 090h, 0A0h, 0C0h, 0A0h, 090h, 088h, 000h, 6 ; 106
108   6744 8890A0C0A090880006
109   674D                 db 018h, 028h, 048h, 088h, 088h, 088h, 088h, 000h, 6 ; 107
109   674D 182848888888880006
110   6756                 db 088h, 0D8h, 0A8h, 088h, 088h, 088h, 088h, 000h, 6 ; 108
110   6756 88D8A8888888880006
111   675F                 db 088h, 088h, 088h, 0F8h, 088h, 088h, 088h, 000h, 6 ; 109
111   675F 888888F88888880006
112   6768                 db 070h, 088h, 088h, 088h, 088h, 088h, 070h, 000h, 6 ; 110
112   6768 708888888888700006
113   6771                 db 0F8h, 088h, 088h, 088h, 088h, 088h, 088h, 000h, 6 ; 111
113   6771 F88888888888880006
114   677A                 db 0F0h, 088h, 088h, 088h, 0F0h, 080h, 080h, 000h, 6 ; 112
114   677A F0888888F080800006
115   6783                 db 070h, 088h, 080h, 080h, 080h, 088h, 070h, 000h, 6 ; 113
115   6783 708880808088700006
116   678C                 db 0F8h, 020h, 020h, 020h, 020h, 020h, 020h, 000h, 6 ; 114
116   678C F82020202020200006
117   6795                 db 088h, 088h, 088h, 078h, 008h, 088h, 070h, 000h, 6 ; 115
117   6795 888888780888700006
118   679E                 db 020h, 070h, 0A8h, 0A8h, 0A8h, 070h, 020h, 000h, 6 ; 116
118   679E 2070A8A8A870200006
119   67A7                 db 088h, 088h, 050h, 020h, 050h, 088h, 088h, 000h, 6 ; 117
119   67A7 888850205088880006
120   67B0                 db 090h, 090h, 090h, 090h, 090h, 090h, 0F8h, 008h, 6 ; 118
120   67B0 909090909090F80806
121   67B9                 db 088h, 088h, 088h, 078h, 008h, 008h, 008h, 000h, 6 ; 119
121   67B9 888888780808080006
122   67C2                 db 0A8h, 0A8h, 0A8h, 0A8h, 0A8h, 0A8h, 0F8h, 000h, 6 ; 120
122   67C2 A8A8A8A8A8A8F80006
123   67CB                 db 0A8h, 0A8h, 0A8h, 0A8h, 0A8h, 0A8h, 0FCh, 004h, 7 ; 121
123   67CB A8A8A8A8A8A8FC0407
124   67D4                 db 0C0h, 040h, 070h, 048h, 048h, 048h, 070h, 000h, 6 ; 122
124   67D4 C04070484848700006
125   67DD                 db 084h, 084h, 0E4h, 094h, 094h, 094h, 0E4h, 000h, 7 ; 123
125   67DD 8484E4949494E40007
126   67E6                 db 080h, 080h, 0F0h, 088h, 088h, 088h, 0F0h, 000h, 6 ; 124
126   67E6 8080F0888888F00006
127   67EF                 db 070h, 088h, 008h, 078h, 008h, 088h, 070h, 000h, 6 ; 125
127   67EF 708808780888700006
128   67F8                 db 090h, 0A8h, 0A8h, 0E8h, 0A8h, 0A8h, 090h, 000h, 6 ; 126
128   67F8 90A8A8E8A8A8900006
129   6801                 db 078h, 088h, 088h, 088h, 078h, 048h, 088h, 000h, 6 ; 127
129   6801 788888887848880006
130   680A                 db 000h, 000h, 060h, 010h, 070h, 090h, 070h, 000h, 5 ; 128
130   680A 000060107090700005
131   6813                 db 000h, 000h, 0E0h, 080h, 0E0h, 090h, 0E0h, 000h, 5 ; 129
131   6813 0000E080E090E00005
132   681C                 db 000h, 000h, 0E0h, 090h, 0E0h, 090h, 0E0h, 000h, 5 ; 130
132   681C 0000E090E090E00005
133   6825                 db 000h, 000h, 0E0h, 080h, 080h, 080h, 080h, 000h, 4 ; 131
133   6825 0000E0808080800004
134   682E                 db 000h, 000h, 030h, 050h, 050h, 050h, 0F8h, 088h, 6 ; 132
134   682E 000030505050F88806
135   6837                 db 000h, 000h, 060h, 090h, 0F0h, 080h, 060h, 000h, 5 ; 133
135   6837 00006090F080600005
136   6840                 db 000h, 000h, 0A8h, 0A8h, 070h, 0A8h, 0A8h, 000h, 6 ; 134
136   6840 0000A8A870A8A80006
137   6849                 db 000h, 000h, 060h, 090h, 020h, 090h, 060h, 000h, 5 ; 135
137   6849 000060902090600005
138   6852                 db 000h, 000h, 090h, 090h, 0B0h, 0D0h, 090h, 000h, 5 ; 136
138   6852 00009090B0D0900005
139   685B                 db 060h, 000h, 090h, 090h, 0B0h, 0D0h, 090h, 000h, 5 ; 137
139   685B 60009090B0D0900005
140   6864                 db 000h, 000h, 090h, 0A0h, 0C0h, 0A0h, 090h, 000h, 5 ; 138
140   6864 000090A0C0A0900005
141   686D                 db 000h, 000h, 030h, 050h, 090h, 090h, 090h, 000h, 5 ; 139
141   686D 000030509090900005
142   6876                 db 000h, 000h, 088h, 0D8h, 0A8h, 088h, 088h, 000h, 6 ; 140
142   6876 000088D8A888880006
143   687F                 db 000h, 000h, 090h, 090h, 0F0h, 090h, 090h, 000h, 5 ; 141
143   687F 00009090F090900005
144   6888                 db 000h, 000h, 060h, 090h, 090h, 090h, 060h, 000h, 5 ; 142
144   6888 000060909090600005
145   6891                 db 000h, 000h, 0F0h, 090h, 090h, 090h, 090h, 000h, 5 ; 143
145   6891 0000F0909090900005
146   689A                 db 000h, 000h, 0E0h, 090h, 090h, 0E0h, 080h, 000h, 5 ; 144
146   689A 0000E09090E0800005
147   68A3                 db 000h, 000h, 060h, 090h, 080h, 090h, 060h, 000h, 5 ; 145
147   68A3 000060908090600005
148   68AC                 db 000h, 000h, 0E0h, 040h, 040h, 040h, 040h, 000h, 4 ; 146
148   68AC 0000E0404040400004
149   68B5                 db 000h, 000h, 090h, 090h, 070h, 010h, 060h, 000h, 5 ; 147
149   68B5 000090907010600005
150   68BE                 db 000h, 020h, 070h, 0A8h, 0A8h, 0A8h, 070h, 020h, 6 ; 148
150   68BE 002070A8A8A8702006
151   68C7                 db 000h, 000h, 090h, 090h, 060h, 090h, 090h, 000h, 5 ; 149
151   68C7 000090906090900005
152   68D0                 db 000h, 000h, 090h, 090h, 090h, 090h, 0F8h, 008h, 6 ; 150
152   68D0 000090909090F80806
153   68D9                 db 000h, 000h, 090h, 090h, 070h, 010h, 010h, 000h, 5 ; 151
153   68D9 000090907010100005
154   68E2                 db 000h, 000h, 0A8h, 0A8h, 0A8h, 0A8h, 0F8h, 000h, 6 ; 152
154   68E2 0000A8A8A8A8F80006
155   68EB                 db 000h, 000h, 0A8h, 0A8h, 0A8h, 0A8h, 0FCh, 004h, 7 ; 153
155   68EB 0000A8A8A8A8FC0407
156   68F4                 db 000h, 000h, 0C0h, 070h, 048h, 048h, 070h, 000h, 6 ; 154
156   68F4 0000C0704848700006
157   68FD                 db 000h, 000h, 084h, 0E4h, 094h, 094h, 0E4h, 000h, 7 ; 155
157   68FD 000084E49494E40007
158   6906                 db 000h, 000h, 080h, 0E0h, 090h, 090h, 0E0h, 000h, 5 ; 156
158   6906 000080E09090E00005
159   690F                 db 000h, 000h, 0E0h, 010h, 070h, 010h, 0E0h, 000h, 5 ; 157
159   690F 0000E0107010E00005
160   6918                 db 000h, 000h, 098h, 0A4h, 0E4h, 0A4h, 098h, 000h, 7 ; 158
160   6918 000098A4E4A4980007
161   6921                 db 000h, 000h, 070h, 090h, 090h, 070h, 090h, 000h, 5 ; 159
161   6921 000070909070900005
162   692A             
001   692A                 ; 3 // Очистить оба экрана
002   692A                 ; 4 // Вход: A - атрбут
003   692A                 ; 5 // Сохраняет: A', BC', DE', HL', IY, IX
004   692A                 ; 7 void clearScreen(a)
005   692A             clearScreen: 
006   692A                 ; 8 {
007   692A                 ; 9 push(a)
008   692A                 ; 10 {
009   692A F5              push af
010   692B                 ; 11 // В прерывании не выбирать видеостраницу
011   692B                 ; 12 videoPage = a = 0;
012   692B 3E 00           ld   a, 0
013   692D 32 73 62        ld   (videoPage), a
014   6930                 ; 14 // Выбрать вторую видеостраницу для записи
015   6930                 ; 15 a = systemPage;
016   6930 3A 74 62        ld   a, (systemPage)
017   6933                 ; 16 a |= 7;
018   6933 F6 07           or   7
019   6935                 ; 17 systemPage = a;
020   6935 32 74 62        ld   (systemPage), a
021   6938                 ; 18 out(bc = 0x7FFD, a);
022   6938 01 FD 7F        ld   bc, 32765
023   693B ED 79           out  (c), a
024   693D                 ; 19 }
025   693D F1              pop  af
026   693E                 ; 21 clearScreen1(hl = [0x5B00 - 1], a);
027   693E 21 FF 5A        ld   hl, 23295
028   6941 CD 58 69        call clearScreen1
029   6944                 ; 22 clearScreen1(hl = [0xDB00 - 1], a);
030   6944 21 FF DA        ld   hl, 56063
031   6947 CD 58 69        call clearScreen1
032   694A                 ; 24 // Выбрать первую видеостраницу для отображения
033   694A                 ; 25 a = systemPage;
034   694A 3A 74 62        ld   a, (systemPage)
035   694D                 ; 26 a &= [~8];
036   694D E6 F7           and  ~(8)
037   694F                 ; 27 systemPage = a;
038   694F 32 74 62        ld   (systemPage), a
039   6952                 ; 28 out(bc = 0x7FFD, a);
040   6952 01 FD 7F        ld   bc, 32765
041   6955 ED 79           out  (c), a
042   6957                 ; 29 }
043   6957 C9              ret
044   6958                 ; 31 void clearScreen1(hl, a)
045   6958             clearScreen1: 
046   6958                 ; 32 {
047   6958                 ; 33 d = h;
048   6958 54              ld   d, h
049   6959                 ; 34 e = l;
050   6959 5D              ld   e, l
051   695A                 ; 35 de--;
052   695A 1B              dec  de
053   695B                 ; 36 push(de, hl)
054   695B                 ; 37 {
055   695B D5              push de
056   695C E5              push hl
057   695D                 ; 38 *hl = 0;
058   695D 36 00           ld   (hl), 0
059   695F                 ; 39 lddr(bc = [0x1B00 - 1]);
060   695F 01 FF 1A        ld   bc, 6911
061   6962 ED B8           lddr
062   6964                 ; 40 }
063   6964 E1              pop  hl
064   6965 D1              pop  de
065   6966                 ; 41 *hl = a;
066   6966 77              ld   (hl), a
067   6967                 ; 42 lddr(bc = [0x300 - 1]);
068   6967 01 FF 02        ld   bc, 767
069   696A ED B8           lddr
070   696C                 ; 43 }
071   696C C9              ret
072   696D             
001   696D             ; ZX Spectrum test (c) 30-10-2019 Alemorf aleksey.f.morozov@gmail.com
002   696D             
003   696D             ;-------------------------------------------------------------------------------
004   696D             ; Вывести изображение
005   696D             ; HL - адрес изображения
006   696D             ; DE - адрес в видеопамяти (5800 - 5CFFh)
007   696D             
008   696D             drawImage: 
009   696D                     ; Преобразование адреса в DE из формата X + Y * 32 в формат YY000 YYYXXXXX
010   696D D5                  PUSH   DE
011   696E 7A                  LD     A, D
012   696F 87                  ADD    A
013   6970 87                  ADD    A
014   6971 87                  ADD    A
015   6972 C6 80               ADD    40h - 0C0h
016   6974 57                  LD     D, A
017   6975             
018   6975                     ; Чтение высоты и ширины. Сохранение  её в стеке
019   6975 4E                  LD     C, (HL)
020   6976 23                  INC    HL
021   6977 46                  LD     B, (HL)
022   6978 23                  INC    HL
023   6979 C5                  PUSH   BC
024   697A             
025   697A                     ; Вывод чернобелой графики
026   697A             drawImage_1: 
027   697A C5                  PUSH   BC
028   697B             
029   697B                     ; Копирование строки
030   697B 3E 08               LD     A, 8
031   697D             drawImage_3: 
032   697D C5                  PUSH   BC
033   697E D5                  PUSH   DE
034   697F 06 00               LD     B, 0
035   6981 ED B0               LDIR
036   6983 D1                  POP    DE
037   6984 C1                  POP    BC
038   6985 14                  INC    D
039   6986 3D                  DEC    A
040   6987 C2 7D 69            JP     NZ, drawImage_3
041   698A             
042   698A                     ; Адрес следующей строки
043   698A 01 20 F8            LD     BC, 0x20 - 0x800
044   698D EB                  EX     DE, HL
045   698E 09                  ADD    HL, BC
046   698F EB                  EX     DE, HL
047   6990 7A                  LD     A, D
048   6991 E6 07               AND    7
049   6993 C4 AC 69            CALL   NZ, drawImage_4
050   6996             
051   6996                     ; Следующая строка
052   6996 C1                  POP    BC
053   6997 10 E1               DJNZ   drawImage_1
054   6999             
055   6999                     ; Восстановление координат вывода и размера
056   6999 C1                  POP    BC
057   699A D1                  POP    DE
058   699B             
059   699B                     ; Цикл для каждой строки
060   699B             drawImage_2: 
061   699B C5                  PUSH   BC
062   699C             
063   699C                     ; Копирование строки
064   699C D5                  PUSH   DE
065   699D 06 00               LD     B, 0
066   699F ED B0               LDIR
067   69A1 D1                  POP    DE
068   69A2             
069   69A2                     ; Адрес следующей строки
070   69A2 EB                  EX     DE, HL
071   69A3 01 20 00            LD     BC, 32
072   69A6 09                  ADD    HL, BC
073   69A7 EB                  EX     DE, HL
074   69A8             
075   69A8                     ; Следующая строка
076   69A8 C1                  POP    BC
077   69A9 10 F0               DJNZ   drawImage_2
078   69AB             
079   69AB C9                  RET
080   69AC             
081   69AC             ;-------------------------------------------------------------------------------
082   69AC             
083   69AC             drawImage_4: 
084   69AC 01 00 07            LD     BC, 0x800 - 0x100
085   69AF EB                  EX     DE, HL
086   69B0 09                  ADD    HL, BC
087   69B1 EB                  EX     DE, HL
088   69B2 C9                  RET
089   69B3             
001   69B3             ; ZX Spectrum test (c) 30-10-2019 Alemorf aleksey.f.morozov@gmail.com
002   69B3             
003   69B3             ;-------------------------------------------------------------------------------
004   69B3             
005   69B3             ;drawText_A dw 0
006   69B3             ;drawText_AC db 0
007   69B3             ;
008   69B3             ;drawText_NL:
009   69B3             ;        LD     HL, (drawText_A)
010   69B3             ;        PUSH   BC
011   69B3             ;        LD     B, 10
012   69B3             ;drawText_NL2:
013   69B3             ;        INC    H ; Цикл
014   69B3             ;        LD     A, H
015   69B3             ;        AND    7
016   69B3             ;        CALL   Z, drawText_L
017   69B3             ;        DJNZ   drawText_NL2
018   69B3             ;        POP    BC
019   69B3             ;        LD     (drawText_A), HL
020   69B3             ;        LD     A, (drawText_AC)
021   69B3             ;        LD     C, A
022   69B3             ;        JP     drawTextSub
023   69B3             
024   69B3             ;-------------------------------------------------------------------------------
025   69B3             
026   69B3             calcCoords: 
027   69B3                     ; ...76210 543XXXXX
028   69B3             
029   69B3                     ; C = L & 7; L >>= 3;
030   69B3 7D                  LD     A, L
031   69B4 E6 07               AND    7
032   69B6 4F                  LD     C, A
033   69B7 CB 3D               SRL    L
034   69B9 CB 3D               SRL    L
035   69BB CB 3D               SRL    L
036   69BD             
037   69BD                     ; L |= ((H << 2) & 0xE0)
038   69BD 7C                  LD     A, H
039   69BE 87                  ADD    A
040   69BF 87                  ADD    A
041   69C0 E6 E0               AND    0E0h
042   69C2 B5                  OR     L
043   69C3 6F                  LD     L, A
044   69C4             
045   69C4                     ; B = (H >> 3) & 0x18
046   69C4 7C                  LD     A, H
047   69C5 0F                  RRCA
048   69C6 0F                  RRCA
049   69C7 0F                  RRCA
050   69C8 E6 18               AND    018h
051   69CA 47                  LD     B, A
052   69CB             
053   69CB                     ; H = 0x40 | (H & 7) | B
054   69CB 7C                  LD     A, H
055   69CC E6 07               AND    007h
056   69CE F6 40               OR     040h
057   69D1 B7 B0               OR     A, B
058   69D2 67                  LD     H, A
059   69D3 C9                  RET
060   69D4             
061   69D4             ;-------------------------------------------------------------------------------
062   69D4             
063   69D4             drawText: 
064   69D4 0E 00               LD     C, 0
065   69D6             drawTextSub: 
066   69D6 1A                  LD     A, (DE)
067   69D7 13                  INC    DE
068   69D8 B7                  OR     A
069   69D9 C8                  RET    Z
070   69DA CD E6 69            CALL   drawCharSub
071   69DD C3 D6 69            JP     drawTextSub
072   69E0             
073   69E0             ;-------------------------------------------------------------------------------
074   69E0             
075   69E0             drawTextEx: 
076   69E0 CD B3 69            CALL   calcCoords
077   69E3 C3 D6 69            JP     drawTextSub
078   69E6             
079   69E6             ;-------------------------------------------------------------------------------
080   69E6             
081   69E6             drawCharSub: 
082   69E6 D5                  PUSH   DE
083   69E7             
084   69E7                     ; Вычисление адреса символа (de = image_font + a * 9)
085   69E7 E5                  PUSH   HL
086   69E8 CD C1 6A            CALL   calcCharAddr
087   69EB EB                  EX     HL, DE
088   69EC E1                  POP    HL
089   69ED E5                  PUSH   HL
090   69EE C5                  PUSH   BC
091   69EF             
092   69EF                     ; Выбор одной из 8 подпрограмм рисования символа
093   69EF 06 08               LD     B, 8
094   69F1 79                  LD     A, C
095   69F2 D9                  EXX
096   69F3 FE 04               CP     4
097   69F5 D2 37 6A            JP     NC, drawText_S4567
098   69F8 FE 02               CP     2
099   69FA D2 1A 6A            JP     NC, drawText_S23
100   69FD FE 01               CP     1
101   69FF D2 0E 6A            JP     NC, drawText_S1
102   6A02             drawText_S0: 
103   6A02                     ; Сдвиг на 0
104   6A02 21 00 00            LD     HL, 00000h ; NOP, NOP
105   6A05 11 00 00            LD     DE, 00000h ; NOP, NOP
106   6A08 01 00 FF            LD     BC, 0FF00h ;
107   6A0B C3 73 6A            JP     drawText_CC
108   6A0E                     ; Сдвиг на 1
109   6A0E             drawText_S1: 
110   6A0E 21 00 0F            LD     HL, 00F00h ; RRCA, NOP
111   6A11 11 00 00            LD     DE, 00000h ; NOP, NOP
112   6A14 01 80 7F            LD     BC, 07F80h ;
113   6A17 C3 73 6A            JP     drawText_CC
114   6A1A             drawText_S23: 
115   6A1A FE 03               CP     3
116   6A1C D2 2B 6A            JP     NC, drawText_S3
117   6A1F                     ; Сдвиг на 2
118   6A1F             drawText_S2: 
119   6A1F 21 0F 0F            LD     HL, 00F0Fh ; RRCA, RRCA
120   6A22 11 00 00            LD     DE, 00000h ; NOP, NOP
121   6A25 01 C0 3F            LD     BC, 03FC0h ;
122   6A28 C3 73 6A            JP     drawText_CC
123   6A2B                     ; Сдвиг на 3
124   6A2B             drawText_S3: 
125   6A2B 21 0F 0F            LD     HL, 00F0Fh ; RRCA, RRCA
126   6A2E 11 0F 00            LD     DE, 0000Fh ; RRCA, NOP
127   6A31 01 E0 1F            LD     BC, 01FE0h ;
128   6A34 C3 73 6A            JP     drawText_CC
129   6A37             drawText_S4567: 
130   6A37 FE 06               CP     6
131   6A39 D2 59 6A            JP     NC, drawText_S67
132   6A3C FE 05               CP     5
133   6A3E D2 4D 6A            JP     NC, drawText_S5
134   6A41             drawText_S4: 
135   6A41                     ; Сдвиг на 4
136   6A41 21 0F 0F            LD     HL, 00F0Fh ; RRCA, RRCA
137   6A44 11 0F 0F            LD     DE, 00F0Fh ; RRCA, RRCA
138   6A47 01 F0 0F            LD     BC, 00FF0h
139   6A4A C3 73 6A            JP     drawText_CC
140   6A4D                     ; Сдвиг на 5
141   6A4D             drawText_S5: 
142   6A4D 21 07 07            LD     HL, 00707h ; RLCA, RLCA
143   6A50 11 00 07            LD     DE, 00700h ; RLCA, NOP
144   6A53 01 F8 07            LD     BC, 007F8h
145   6A56 C3 73 6A            JP     drawText_CC
146   6A59             drawText_S67: 
147   6A59 FE 07               CP     7
148   6A5B D2 6A 6A            JP     NC, drawText_S7
149   6A5E                     ; Сдвиг на 6
150   6A5E             drawText_S6: 
151   6A5E 21 07 07            LD     HL, 00707h ; RLCA, RLCA
152   6A61 11 00 00            LD     DE, 00000h ; NOP, NOP
153   6A64 01 FC 03            LD     BC, 003FCh
154   6A67 C3 73 6A            JP     drawText_CC
155   6A6A                     ; Сдвиг на 7
156   6A6A             drawText_S7: 
157   6A6A 21 00 07            LD     HL, 00700h ; RLCA, NOP
158   6A6D 11 00 00            LD     DE, 00000h ; NOP, NOP
159   6A70 01 FE 07            LD     BC, 007FEh
160   6A73                     ; Вывод символа
161   6A73             drawText_CC: 
162   6A73 22 84 6A            LD     (drawText_C1), HL
163   6A76 ED 53 86 6A         LD     (drawText_C1 + 2), DE
164   6A7A 78                  LD     A, B
165   6A7B 32 8A 6A            LD     (drawText_C2 + 1), A
166   6A7E 79                  LD     A, C
167   6A7F 32 8F 6A            LD     (drawText_C3 + 1), A
168   6A82 D9                  EXX
169   6A83             drawText_C: 
170   6A83 1A                  LD     A, (DE) ; Половинка
171   6A84             drawText_C1: 
172   6A84 00                  NOP
173   6A85 00                  NOP
174   6A86 00                  NOP
175   6A87 00                  NOP
176   6A88 4F                  LD     C, A
177   6A89             drawText_C2: 
178   6A89 E6 00               AND    0
179   6A8B AE                  XOR    (HL)
180   6A8C 77                  LD     (HL), A
181   6A8D 79                  LD     A, C ; Половинка
182   6A8E             drawText_C3: 
183   6A8E E6 00               AND    0
184   6A90 2C                  INC    L ; влево
185   6A91 AE                  XOR    (HL)
186   6A92 77                  LD     (HL), A
187   6A93 2D                  DEC    L ; вправо
188   6A94 24                  INC    H ; Цикл
189   6A95 7C                  LD     A, H
190   6A96 E6 07               AND    7
191   6A98 CC B0 6A            CALL   Z, drawText_L
192   6A9B 13                  INC    DE
193   6A9C 05                  DEC    B
194   6A9D C2 83 6A            JP     NZ, drawText_C
195   6AA0                     ; Конец
196   6AA0             drawText_1: 
197   6AA0 C1                  POP    BC
198   6AA1 E1                  POP    HL
199   6AA2 1A                  LD     A, (DE)
200   6AA3 47                  LD     B, A
201   6AA4 81                  ADD    C
202   6AA5 FE 08               CP     8
203   6AA7 DA AD 6A            JP     C, drawText_2
204   6AAA E6 07               AND    7
205   6AAC 2C                  INC    L ; Вправо
206   6AAD             drawText_2: 
207   6AAD 4F                  LD     C, A
208   6AAE             
209   6AAE D1                  POP    DE
210   6AAF C9                  RET
211   6AB0             
212   6AB0             ;-------------------------------------------------------------------------------
213   6AB0             
214   6AB0             drawText_L: 
215   6AB0 D5                  PUSH   DE
216   6AB1 11 20 F8            LD     DE, 20h-800h
217   6AB4 19                  ADD    HL, DE
218   6AB5 D1                  POP    DE
219   6AB6 7C                  LD     A, H
220   6AB7 E6 07               AND    7
221   6AB9 C8                  RET    Z
222   6ABA D5                  PUSH   DE
223   6ABB 11 00 07            LD     DE, 800h-100h
224   6ABE 19                  ADD    HL, DE
225   6ABF D1                  POP    DE
226   6AC0 C9                  RET
227   6AC1             
228   6AC1             ;-------------------------------------------------------------------------------
229   6AC1             
230   6AC1             calcCharAddr: 
231   6AC1                     ; Вычисление адреса символа (de = image_font + a * 9)
232   6AC1 D6 20               SUB    ' '
233   6AC3 FE 60               CP     96
234   6AC5 DA CA 6A            JP     C, drawTextRus
235   6AC8 D6 40               SUB    64
236   6ACA             drawTextRus: 
237   6ACA 26 00               LD     H, 0
238   6ACC 6F                  LD     L, A
239   6ACD 54                  LD     D, H
240   6ACE 5D                  LD     E, L
241   6ACF 29                  ADD    HL, HL
242   6AD0 29                  ADD    HL, HL
243   6AD1 29                  ADD    HL, HL
244   6AD2 19                  ADD    HL, DE
245   6AD3 11 8A 63            LD     DE, image_font
246   6AD6 19                  ADD    HL, DE
247   6AD7 C9                  RET
248   6AD8             
249   6AD8             ;-------------------------------------------------------------------------------
250   6AD8             ; DE - текст / С - результат
251   6AD8             
252   6AD8             measureText: 
253   6AD8 0E 00               LD     C, 0
254   6ADA             measureText_1: 
255   6ADA                     ; Чтение символа (a = *de++)
256   6ADA 1A                  LD     A, (DE)
257   6ADB 13                  INC    DE
258   6ADC B7                  OR     A
259   6ADD C8                  RET    Z
260   6ADE             
261   6ADE                     ; Вычисление адреса символа (de = image_font + a * 9)
262   6ADE D5                  PUSH   DE
263   6ADF CD C1 6A            CALL   calcCharAddr
264   6AE2 11 08 00            LD     DE, 8
265   6AE5 19                  ADD    HL, DE
266   6AE6 7E                  LD     A, (HL)
267   6AE7 81                  ADD    C
268   6AE8 4F                  LD     C, A
269   6AE9 D1                  POP    DE
270   6AEA C3 DA 6A            JP     measureText_1
271   6AED             
272   6AED             ;-------------------------------------------------------------------------------
273   6AED             
274   6AED             drawTextCenter: 
275   6AED D5                  PUSH   DE
276   6AEE E5                  PUSH   HL
277   6AEF CD D8 6A            CALL   measureText        
278   6AF2 3E 00               LD     A, 256
279   6AF4 91                  SUB    C
280   6AF5 CB 3F               SRL    A
281   6AF7 E1                  POP    HL
282   6AF8 D1                  POP    DE
283   6AF9 6F                  LD     L, A
284   6AFA CD E0 69            CALL   drawTextEx
285   6AFD             
001   6AFD                 ; 3 const int KEY_UP = 1;
002   6AFD                 ; 4 const int KEY_DOWN = 2;
003   6AFD                 ; 5 const int KEY_LEFT = 4;
004   6AFD                 ; 6 const int KEY_RIGHT = 8;
005   6AFD                 ; 7 const int KEY_FIRE = 16;
006   6AFD                 ; 9 // Использует A, BC, HL
007   6AFD                 ; 10 void readKey()
008   6AFD             readKey: 
009   6AFD                 ; 11 {
010   6AFD                 ; 12 c = in(bc = 0xEFFE);
011   6AFD 01 FE EF        ld   bc, 61438
012   6B00 ED 48           in   c, (c)
013   6B02                 ; 13 a ^= a;
014   6B02 AF              xor  a
015   6B03                 ; 14 if (c & 0x04) a |= KEY_RIGHT;
016   6B03 CB 51           bit  2, c
017   6B05 CA 0A 6B        jp   z, l1000
018   6B08 F6 08           or   8
019   6B0A                 ; 15 if (c & 0x08) a |= KEY_UP;
020   6B0A             l1000: 
021   6B0A CB 59           bit  3, c
022   6B0C CA 11 6B        jp   z, l1001
023   6B0F F6 01           or   1
024   6B11                 ; 16 if (c & 0x10) a |= KEY_DOWN;
025   6B11             l1001: 
026   6B11 CB 61           bit  4, c
027   6B13 CA 18 6B        jp   z, l1002
028   6B16 F6 02           or   2
029   6B18                 ; 17 c = in(bc = 0xF7FE);
030   6B18             l1002: 
031   6B18 01 FE F7        ld   bc, 63486
032   6B1B ED 48           in   c, (c)
033   6B1D                 ; 18 if (c & 0x10) a |= KEY_LEFT;
034   6B1D CB 61           bit  4, c
035   6B1F CA 24 6B        jp   z, l1003
036   6B22 F6 04           or   4
037   6B24                 ; 19 c = in(bc = 0x7FFE);
038   6B24             l1003: 
039   6B24 01 FE 7F        ld   bc, 32766
040   6B27 ED 48           in   c, (c)
041   6B29                 ; 20 if (c & 0x01) a |= KEY_FIRE;
042   6B29 CB 41           bit  0, c
043   6B2B CA 30 6B        jp   z, l1004
044   6B2E F6 10           or   16
045   6B30                 ; 21 a ^= 0xFF;
046   6B30             l1004: 
047   6B30 EE FF           xor  255
048   6B32                 ; 23 // Чтение прошлого значения и сохранение нового
049   6B32                 ; 24 b = a;
050   6B32 47              ld   b, a
051   6B33                 ; 25 hl = &keyPressed;
052   6B33 21 76 62        ld   hl, keyPressed
053   6B36                 ; 26 a = *hl;
054   6B36 7E              ld   a, (hl)
055   6B37                 ; 27 *hl = b;
056   6B37 70              ld   (hl), b
057   6B38                 ; 29 // Выделение события нажатия
058   6B38                 ; 30 a ^= 0xFF;
059   6B38 EE FF           xor  255
060   6B3A                 ; 31 a &= b;
061   6B3A A0              and  b
062   6B3B                 ; 32 hl = &keyTrigger;
063   6B3B 21 75 62        ld   hl, keyTrigger
064   6B3E                 ; 33 a |= *hl;
065   6B3E B6              or   (hl)
066   6B3F                 ; 34 *hl = a;
067   6B3F 77              ld   (hl), a
068   6B40                 ; 36 return;
069   6B40 C9              ret
070   6B41                 ; 37 }
071   6B41 C9              ret
072   6B42             
